# ToBookToStay

**ToBookToStay** – это проект платформы для аренды жилья, построенная на Django с использованием базы данных MySQL. Этот проект настроен для работы в контейнерах через Docker и включает поддержку переменных окружения через `django-environ`. Также поддерживается развертывание на AWS с использованием RDS для базы данных и S3 для хранения медиафайлов.

## Структура проекта

```
ToBookToStay/
│
├── apps/                            # Основная директория приложений Django   
│   ├── bookings/                    # Приложение для управления бронированиями недвижимости
│   │   ├── actions/                         # Дополнительные действия для работы с бронированиями
│   │   │   ├── __init__.py
│   │   │   └── booking_admin.py             # Админские действия для управления бронированиями
│   │   ├── admin/                           # Настройки админ-панели для бронирований
│   │   │   ├── __init__.py
│   │   │   └── booking_admin.py             # Кастомизация админ-панели для управления бронированиями
│   │   ├── choices/                         # Определения возможных вариантов значений полей
│   │   │   ├── __init__.py
│   │   │   └── booking_status.py            # Определение статусов бронирований (e.g., PENDING, CONFIRMED, CANCELED)
│   │   ├── forms/                           # Формы для админ-панели
│   │   │   ├── __init__.py
│   │   │   └── booking_admin_form.py        # Кастомные формы для управления бронированиями в админ-панели
│   │   ├── migrations/                      # Миграции базы данных для приложения bookings
│   │   │   └── __init__.py
│   │   ├── mixins/                          # Миксины для работы с бронированиями
│   │   │   ├── __init__.py
│   │   │   └── status_mixins.py             # Миксины для обработки статусов бронирований
│   │   ├── models/                          # Модели данных для бронирований
│   │   │   ├── __init__.py
│   │   │   └── booking.py                   # Модель бронирования с кастомными полями и методами
│   │   ├── permissions/                     # Кастомные разрешения для работы с бронированиями
│   │   │   ├── __init__.py
│   │   │   └── owner_permissions.py         # Разрешения для владельцев бронирований и владельцев листингов
│   │   ├── serializers/                     # Сериализаторы для преобразования данных бронирований и валидации
│   │   │   ├── __init__.py
│   │   │   └── booking_serializers.py       # Сериализаторы для создания, обновления, просмотра и изменения статусов бронирований
│   │   ├── tests/                           # Тесты для приложения bookings
│   │   │   ├── admin/                     
│   │   │   │   ├── __init__.py
│   │   │   │   ├── test_booking_admin_actions.py          # Тесты админских действий над бронированиями
│   │   │   │   ├── test_booking_admin_configuration.py    # Тесты конфигурации админ-панели
│   │   │   │   ├── test_booking_admin_form.py             # Тесты кастомных форм в админ-панели
│   │   │   │   ├── test_booking_admin_general.py          # Общие тесты для админки
│   │   │   │   └── test_booking_mixins.py                 # Тесты миксинов для бронирований
│   │   │   ├── models/                 
│   │   │   │   ├── __init__.py
│   │   │   │   ├── test_booking_clean.py                  # Тесты для метода очистки данных в модели бронирования
│   │   │   │   ├── test_booking_edge_cases.py             # Тесты крайних случаев в модели бронирования
│   │   │   │   ├── test_booking_exceptions.py             # Тесты исключений в модели бронирования
│   │   │   │   ├── test_booking_fields.py                 # Тесты отдельных полей модели бронирования
│   │   │   │   ├── test_booking_save.py                   # Тесты метода сохранения бронирования
│   │   │   │   ├── test_booking_status_methods.py         # Тесты методов, связанных со статусами бронирования
│   │   │   │   └── test_booking_str.py                    # Тесты строкового представления модели бронирования
│   │   │   ├── serializers/            
│   │   │   │   ├── __init__.py
│   │   │   │   ├── test_booking_create_serializer.py           # Тесты сериализатора создания бронирования
│   │   │   │   ├── test_booking_detail_serializer.py           # Тесты сериализатора детального просмотра бронирования
│   │   │   │   ├── test_booking_list_serializer.py             # Тесты сериализатора списка бронирований
│   │   │   │   ├── test_booking_status_action_serializer.py    # Тесты сериализатора изменения статуса бронирования
│   │   │   │   └── test_booking_update_serializer.py           # Тесты сериализатора обновления бронирования
│   │   │   ├── views/                   
│   │   │   │   ├── __init__.py
│   │   │   │   ├── test_booking_cancel_view.py         # Тесты вьюшки отмены бронирования
│   │   │   │   ├── test_booking_complete_view.py       # Тесты вьюшки завершения бронирования
│   │   │   │   ├── test_booking_confirm_view.py        # Тесты вьюшки подтверждения бронирования
│   │   │   │   ├── test_booking_create_view.py         # Тесты вьюшки создания бронирования
│   │   │   │   ├── test_booking_detail_view.py         # Тесты вьюшки детального просмотра бронирования
│   │   │   │   ├── test_booking_list_view.py           # Тесты вьюшки списка бронирований
│   │   │   │   ├── test_booking_request_view.py        # Тесты вьюшки запроса бронирования
│   │   │   │   ├── test_booking_soft_delete_view.py    # Тесты вьюшки мягкого удаления бронирования
│   │   │   │   └── test_update_booking_view.py         # Тесты вьюшки обновления бронирования
│   │   │   └── __init__.py
│   │   ├── views/                           # Вьюшки для реализации API работы с бронированиями
│   │   │   ├── __init__.py
│   │   │   └── booking_views.py             # Основные вьюшки для управления бронированиями (создание, обновление, изменение статусов)
│   │   ├── __init__.py
│   │   ├── apps.py                          # Конфигурация приложения bookings
│   │   └── urls.py                          # Общая URL-конфигурация приложения bookings
│   │                    
│   ├── listings/                       # Приложение для управления объявлениями о недвижимости
│   │   ├── actions/                    # Дополнительные действия для работы с объявлениями
│   │   │   ├── __init__.py
│   │   │   └── listing_admin.py        # Админские действия для управления объявлениями
│   │   ├── admin/                      # Настройки админ-панели для объявлений
│   │   │   ├── __init__.py
│   │   │   └── listing_admin.py        # Кастомизация админ-панели для управления объявлениями
│   │   ├── choices/                    # Определения возможных вариантов значений полей
│   │   │   ├── __init__.py
│   │   │   ├── listing_status.py       # Определение статусов объявлений (e.g., ACTIVE, DEACTIVATED, DELETED)
│   │   │   └── property_type.py        # Определение типов недвижимости (e.g., квартира, дом)
│   │   ├── forms/                      # Формы для админ-панели
│   │   │   ├── __init__.py
│   │   │   └── listing_admin_form.py   # Кастомные формы для управления объявлениями в админ-панели
│   │   ├── migrations/                 # Миграции базы данных для приложения listings
│   │   │   └── __init__.py
│   │   ├── mixins/                     # Миксины для работы с объявлениями
│   │   │   ├── __init__.py
│   │   │   └── status_mixins.py        # Миксины для обработки статусов объявлений
│   │   ├── models/                     # Модели данных для объявлений
│   │   │   ├── __init__.py
│   │   │   └── listing.py              # Модель объявления с кастомными полями и методами
│   │   ├── permissions/                # Кастомные разрешения для работы с объявлениями
│   │   │   ├── __init__.py
│   │   │   ├── general_permissions.py  # Общие разрешения для работы с объявлениями
│   │   │   └── owner_permissions.py    # Разрешения для владельцев объявлений
│   │   ├── serializers/                # Сериализаторы для преобразования данных объявлений и валидации
│   │   │   ├── __init__.py
│   │   │   └── listing_serializers.py  # Сериализаторы для создания, обновления, просмотра и управления статусами объявлений
│   │   ├── tests/                      # Тесты для приложения listings
│   │   │   ├── admin/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── test_listing_admin_actions.py    # Тесты админских действий над объявлениями
│   │   │   │   ├── test_listing_admin_form.py       # Тесты кастомных форм в админ-панели
│   │   │   │   ├── test_listing_admin_general.py    # Общие тесты для админки
│   │   │   │   └── test_listing_mixins.py           # Тесты миксинов для объявлений
│   │   │   ├── models/
│   │   │   │   ├── __init__.py
│   │   │   │   └── test_listing_model.py         # Тесты модели объявления
│   │   │   ├── serializers/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── test_listing_create_serializer.py           # Тесты сериализатора создания объявления
│   │   │   │   ├── test_listing_detail_serializer.py           # Тесты сериализатора детального просмотра объявления
│   │   │   │   ├── test_listing_list_serializer.py             # Тесты сериализатора списка объявлений
│   │   │   │   ├── test_listing_status_action_serializer.py    # Тесты сериализатора изменения статуса объявления
│   │   │   │   └── test_listing_update_serializer.py           # Тесты сериализатора обновления объявления
│   │   │   ├── views/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── test_listing_activate_views.py       # Тесты вьюшки активации объявления
│   │   │   │   ├── test_listing_create_view.py          # Тесты вьюшки создания объявления
│   │   │   │   ├── test_listing_deactivate_views.py     # Тесты вьюшки деактивации объявления
│   │   │   │   ├── test_listing_detail_view.py          # Тесты вьюшки детального просмотра объявления
│   │   │   │   ├── test_listing_list_view.py            # Тесты вьюшки списка объявлений
│   │   │   │   ├── test_listing_soft_delete_views.py    # Тесты вьюшки мягкого удаления объявления
│   │   │   │   ├── test_listing_update_view.py          # Тесты вьюшки обновления объявления
│   │   │   │   └── test_my_listings_view.py             # Тесты вьюшки просмотра объявлений пользователя
│   │   │   └── __init__.py
│   │   ├── views/                  # Вьюшки для реализации API работы с объявлениями
│   │   │   ├── __init__.py
│   │   │   └── listing_views.py    # Основные вьюшки для управления объявлениями (создание, обновление, изменение статусов)
│   │   ├── __init__.py
│   │   ├── apps.py                 # Конфигурация приложения listings
│   │   ├── urls.py                 # Общая URL-конфигурация приложения listings
│   │   └── routers.py              # (Предполагается) Настройка роутеров для вьюшек приложения
│   │
│   ├── users/                       # Приложение для управления пользователями
│   │   ├── actions/
│   │   │   ├── __init__.py
│   │   │   └── user_admin.py        # Дополнительные действия для администраторов пользователей
│   │   ├── admin/
│   │   │   ├── __init__.py
│   │   │   └── user_admin.py        # Настройки модели пользователя для админ-панели Django
│   │   ├── choices/
│   │   │   ├── __init__.py
│   │   │   └── user_status.py       # Определение статусов пользователей (e.g., ACTIVE, DELETED)
│   │   ├── forms/
│   │   │   ├── __init__.py
│   │   │   └── user_admin_form.py   # Кастомные формы для управления пользователями в админ-панели
│   │   ├── migrations/              # Миграции базы данных для приложения users
│   │   │   └── __init__.py
│   │   ├── mixins/
│   │   │   ├── __init__.py
│   │   │   ├── password_mixin.py    # Миксин для управления паролем пользователей
│   │   │   └── status_mixins.py     # Миксин для работы со статусами пользователей
│   │   ├── models/
│   │   │   ├── __init__.py
│   │   │   └── user.py              # Модель пользователя с кастомными полями и методами
│   │   ├── serializers/
│   │   │   ├── __init__.py
│   │   │   └── user_serializers.py  # Сериализаторы для преобразования данных пользователей и валидации
│   │   ├── services/              
│   │   │   ├── __init__.py
│   │   │   └── listing_service.py   # Сервисы для работы с объявлениями (e.g., проверка доступности дат)
│   │   ├── tests/                   # Тесты для приложения users
│   │   │   ├── admin/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── test_user_admin_actions.py  # Тесты админских действий над пользователями
│   │   │   │   ├── test_user_admin_change.py   # Тесты изменений пользователя в админке
│   │   │   │   ├── test_user_admin_creation.py # Тесты создания пользователя через админку
│   │   │   │   └── test_user_admin_general.py  # Общие тесты для админки
│   │   │   ├── models/
│   │   │   │   ├── __init__.py
│   │   │   │   └── test_user_model.py          # Тесты кастомной модели пользователя
│   │   │   ├── serializers/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── test_activate_user_serializer.py    # Тесты сериализатора активации пользователей
│   │   │   │   ├── test_change_password_serializer.py  # Тесты сериализатора изменения пароля
│   │   │   │   ├── test_create_user_serializer.py      # Тесты сериализатора создания пользователей
│   │   │   │   ├── test_deactivate_user_serializer.py  # Тесты сериализатора деактивации
│   │   │   │   ├── test_delete_user_serializer.py      # Тесты сериализатора мягкого удаления
│   │   │   │   ├── test_update_user_serializer.py      # Тесты сериализатора обновления профиля
│   │   │   │   ├── test_user_detail_serializer.py      # Тесты сериализатора детального просмотра профиля
│   │   │   │   └── test_user_list_serializer.py        # Тесты сериализатора списка пользователей
│   │   │   ├── services/             
│   │   │   │   ├── __init__.py
│   │   │   │   ├── test_get_available_dates.py             # Тесты для сервиса проверки доступных дат
│   │   │   │   └── test_get_available_dates_by_month.py    # Тесты для сервиса получения доступных дат по месяцам
│   │   │   ├── views/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── test_activate_user_view.py      # Тесты вьюшки активации пользователя
│   │   │   │   ├── test_change_password_view.py    # Тесты вьюшки изменения пароля
│   │   │   │   ├── test_create_user_view.py        # Тесты вьюшки регистрации пользователя
│   │   │   │   ├── test_deactivate_user_view.py    # Тесты вьюшки деактивации пользователя
│   │   │   │   ├── test_delete_user_view.py        # Тесты вьюшки мягкого удаления пользователя
│   │   │   │   ├── test_user_detail_view.py        # Тесты вьюшки детального просмотра профиля
│   │   │   │   ├── test_user_list_view.py          # Тесты вьюшки списка пользователей
│   │   │   │   └── test_user_update_view.py        # Тесты вьюшки обновления профиля
│   │   │   └── __init__.py
│   │   ├── utils/
│   │   │   └── __init__.py
│   │   ├── validators/
│   │   ├── __init__.py
│   │   │   └── user_validators.py          # Кастомные валидаторы для проверки данных пользователя
│   │   ├── views/
│   │   │   ├── __init__.py
│   │   │   └── user_views.py               # Реализация API-вьюшек для работы с пользователями
│   │   ├── __init__.py
│   │   ├── admin_urls.py                   # URL-конфигурация для админских операций над пользователями
│   │   ├── apps.py                         # Конфигурация приложения users
│   │   └── urls.py                         # Общая URL-конфигурация приложения
│   ├── __init__.py
│   └── routers.py                          # Настройка роутеров для вьюшек приложения
│
├── common/                         # Общие утилиты и вспомогательные модули
│   ├── tests/
│   │   ├── __init__.py
│   │   └── test_localized_docs.py  # Тесты для локализации docstring'ов
│   └── utils/
│       ├── __init__.py
│       ├── doc_config.py           # Конфигурация локализации документации
│       └── localized_docs.py       # Локализация docstring'ов для функций и модулей
│
├── core/                           # Основное приложение Django (настройки и запуск)
│   ├── __init__.py
│   ├── asgi.py                     # ASGI конфигурация для асинхронного взаимодействия
│   ├── settings.py                 # Основные настройки проекта Django
│   ├── urls.py                     # Главная URL-конфигурация проекта
│   └── wsgi.py                     # WSGI конфигурация для развертывания на серверах
│
├── data/                           # Директория для хранения данных базы данных MySQL (используется в Docker)
├── htmlcov/                        # Директория для хранения отчетов о покрытии кода (coverage reports)
├── venv/                           # Виртуальное окружение Python
│
├── .dockerignore                   # Список файлов и папок, игнорируемых Docker
├── .env                            # Переменные окружения для проекта
├── .env.example                    # Пример файла переменных окружения
├── .gitattributes                  # Управление атрибутами файлов в Git
├── .gitignore                      # Список файлов и папок, игнорируемых в репозитории Git
├── docker-compose.yml              # Конфигурация Docker Compose для запуска проекта
├── Dockerfile                      # Инструкция по созданию Docker-образа для приложения
├── manage.py                       # Главный скрипт управления проектом Django
├── README.md                       # Описание проекта и документация
├── requirements.txt                # Список зависимостей Python для проекта
└── wait_for_db.sh                  # Скрипт для ожидания запуска базы данных перед применением миграций
```

## Требования

Перед началом работы убедитесь, что у вас установлены следующие программы:

- **Docker** (v26.1 и выше)
- **Docker Compose** (v2.27 и выше)
- **Python** (v3.11)

---

## Приложение `users`

Приложение **`users`** отвечает за управление пользователями, их регистрацией, аутентификацией, профилем, правами доступа, а также операциями активации, деактивации и мягкого удаления учетных записей. Приложение построено с использованием Django и Django REST Framework.

### Основные возможности приложения `users`:

- **Регистрация пользователей** – создание новых учетных записей с возможностью верификации данных.
- **Аутентификация** – реализована с использованием JWT-токенов (JSON Web Token) для безопасной аутентификации пользователей через API.
- **Управление профилем** – пользователи могут обновлять свои профили, а администраторы могут управлять учетными записями других пользователей.
- **Активация и деактивация** – возможность активации и деактивации учетных записей пользователей администратором.
- **Мягкое удаление** – учетные записи пользователей могут быть мягко удалены путем смены статуса на "DELETED", без фактического удаления из базы данных.
- **Проверка прав доступа** – встроенные ограничения на основе статуса пользователя (PENDING, ACTIVE, DEACTIVATED, DELETED) и уровня доступа (обычные пользователи, администраторы).

### Структура приложения

- **models/** – модели данных для пользователей (`User`), включая кастомный менеджер для выборки по статусу пользователя.
- **serializers/** – сериализаторы для операций с пользователями, валидация данных при регистрации, обновлении профиля, изменении пароля, активации, деактивации и мягком удалении.
- **views/** – реализация API-вьюшек для работы с пользователями, аутентификации, а также проверки прав доступа и разрешений.
- **validators/** – кастомные валидаторы для проверки данных в модели пользователя.
- **mixins/** – утилиты и общие функции для работы с пользователями, такие как миксины для обработки статусов и проверки паролей.
- **tests/** – тесты для проверки логики приложения, включая тестирование вьюшек, сериализаторов и проверки прав доступа.

### Особенности работы с приложением `users`

- **Доступ к профилю**: пользователи могут просматривать и редактировать только свои профили, тогда как администраторы имеют доступ ко всем учетным записям. Пользователи со статусом `DELETED` не могут просматривать или изменять свои профили.
- **Проверка прав**: доступ ко многим операциям (таким как активация, деактивация, удаление) ограничен для обычных пользователей и доступен только администраторам.
- **Пагинация**: списки пользователей и запросов к API обрабатываются с использованием глобальной настройки пагинации, чтобы обеспечить оптимальную загрузку данных.
- **Локализация**: docstring'и и сообщения об ошибках в приложении поддерживают локализацию для многоязычных проектов, используя декораторы и общий конфигурационный файл.

### Тестирование

- **Unit-тесты**: покрытие основных операций с пользователями, включая:
  - **Admin**: тестирование админских функций (создание, изменение, действия) в файлах, находящихся в `tests/admin/`.
  - **Models**: тестирование поведения и валидации кастомной модели пользователя (`User`) в файле `tests/models/test_user_model.py`.
  - **Serializers**: проверка сериализаторов для регистрации, активации, деактивации, изменения пароля, обновления и удаления учетных записей. Тесты организованы по отдельным файлам в директории `tests/serializers/`.
  - **Views**: проверка вьюшек (регистрация, просмотр, изменение, удаление, активация, деактивация) с учетом прав доступа и статусов пользователей. Тесты размещены в отдельных файлах внутри директории `tests/views/`.

- **Разделение тестов**: тесты организованы по функциональным классам (регистрация, обновление, изменение пароля и т. д.) и сгруппированы в отдельных файлах для каждой категории (admin, serializers, views, models).

- **Запуск тестов**: все тесты приложения `users` можно запустить с помощью команды:

```bash
python manage.py test apps.users.tests
```

### Используемые технологии

- **Django** – фреймворк для веб-приложений.
- **Django REST Framework** – создание API для управления пользователями.
- **Simple JWT** – обеспечение аутентификации пользователей с использованием токенов.

---

## Приложение `listings`

Приложение **`listings`** отвечает за управление объявлениями о недвижимости. Оно предоставляет функциональность для создания, обновления, просмотра, изменения статуса и мягкого удаления объявлений. Реализовано с использованием Django и Django REST Framework.

### Основные возможности приложения `listings`:

- **Создание и обновление объявлений** – пользователи с бизнес-аккаунтом могут создавать новые объявления и вносить в них изменения. Администраторы также могут управлять объявлениями.
- **Управление статусом** – объявления имеют различные статусы, такие как `DRAFT`, `ACTIVE`, `DEACTIVATED`, `DELETED`. Администраторы и владельцы могут изменять статусы объявлений в зависимости от их прав доступа.
- **Мягкое удаление** – объявления могут быть мягко удалены, что позволяет их восстановление в будущем. Мягкое удаление изменяет статус объявления на `DELETED`.
- **Доступ к объявлениям** – пользователи могут просматривать свои объявления, а администраторы имеют доступ ко всем объявлениям в системе. Обычные пользователи видят только активные объявления других пользователей.
- **Фильтрация и поиск** – поддерживает фильтрацию объявлений по цене, местоположению, количеству комнат, типу недвижимости и статусу. Реализован поиск по заголовку, описанию, местоположению и адресу.
- **Права доступа** – встроены проверки прав доступа, позволяющие только владельцам объявлений или администраторам изменять и удалять объявления.
- **Проверка доступности** – метод `is_available` в модели `Listing` позволяет проверять доступность объявления для указанных дат, чтобы предотвратить конфликты бронирования.
- **Получение доступных дат** – реализован API-эндпоинт `AvailableDatesByMonthView`, который предоставляет список доступных дат для бронирования по месяцам.

### Структура приложения

- **models/** – модель данных для объявлений (`Listing`), включая поля, связанные с владельцем, описанием, типом недвижимости, ценой, статусом и метаданными. 
- **serializers/** – сериализаторы для различных операций с объявлениями, включая создание, обновление, просмотр и изменение статуса.
- **views/** – API-вьюшки для управления объявлениями, их статусов, а также для предоставления доступа к объявлениям конкретных пользователей или их списка.
- **validators/** – валидаторы данных для объявления, определенные в `listing_admin_form.py`.
- **mixins/** – утилиты и миксины для работы со статусами и отображения состояния объявления в админке.
- **permissions/** – кастомные разрешения для управления объявлениями, такие как `IsBusinessAccount` и `IsOwnerOrReadOnly`.
- **admin/** – включает в себя кастомные действия для админ-панели, позволяющие активировать, деактивировать и мягко удалять объявления.
- **tests/** – тесты для проверки функциональности приложения `listings`, включая тестирование вьюшек, сериализаторов, и проверки прав доступа.

### Особенности работы с приложением `listings`

- **Создание и обновление**: Только пользователи с бизнес-аккаунтом и администраторы могут создавать и обновлять объявления. В процессе создания и обновления проверяется валидность всех данных (цена, количество комнат, тип недвижимости и др.).
- **Изменение статуса**: Для изменения статуса объявления (например, активация, деактивация, мягкое удаление) реализованы специальные API-вьюхи. Только владельцы объявлений или администраторы могут изменять их статус.
- **Мягкое удаление**: Метод `soft_delete` в модели `Listing` изменяет статус объявления на `DELETED`, не удаляя его из базы данных.
- **Права доступа**: Реализованы специальные разрешения (`IsBusinessAccount`, `IsOwnerOrReadOnly`), чтобы только авторизованные пользователи с бизнес-аккаунтом или администраторы могли изменять или удалять объявления.
- **Фильтрация и поиск**: Объявления можно фильтровать по нескольким параметрам (цена, местоположение, тип недвижимости и др.) и искать по заголовку, описанию или адресу.
- **Админ-панель**: В админ-панели доступны действия для массового изменения статусов объявлений. Отображение статусов и метаданных реализовано через миксины (`StatusMixin`, `SoftDeleteMixin`).

### Тестирование

- **Unit-тесты**: (Предполагается, что будут) покрывают основные операции с объявлениями, включая:
  - **Models**: тестирование поведения и валидации модели `Listing`.
  - **Serializers**: проверка сериализаторов для создания, обновления, изменения статуса и мягкого удаления объявлений.
  - **Views**: тестирование вьюшек для просмотра, создания, обновления и изменения статусов объявлений, с учетом прав доступа и фильтрации.
  - **Admin**: тестирование кастомных действий в админ-панели (активация, деактивация, мягкое удаление).

- **Разделение тестов**: тесты организованы по функциональным классам (создание, обновление, изменение статуса) и сгруппированы в отдельных файлах для каждой категории (models, serializers, views).

- **Запуск тестов**: все тесты приложения `listings` можно запустить с помощью команды:
```bash
python manage.py test apps.listings.tests
```

### Используемые технологии

- **Django** – фреймворк для веб-приложений.
- **Django REST Framework** – для реализации API.
- **Django Filter** – библиотека для упрощенной фильтрации запросов в API.
- **Simple JWT** – для аутентификации с использованием токенов.

---

## Приложение `bookings`

Приложение **`bookings`** отвечает за управление бронированиями на платформе аренды жилья. Оно предоставляет функциональность для создания, просмотра, обновления, изменения статуса, а также мягкого удаления бронирований. Реализовано с использованием Django и Django REST Framework.

### Основные возможности приложения `bookings`:

- **Создание и обновление бронирований** – пользователи могут создавать новые бронирования и вносить изменения в существующие. Администраторы также могут управлять бронированиями.
- **Управление статусами** – бронирования имеют различные статусы, такие как `PENDING`, `REQUEST`, `CONFIRMED`, `COMPLETED`, `CANCELED`, `DELETED`. Пользователи могут изменять статус своих бронирований в зависимости от прав доступа.
- **Мягкое удаление** – бронирования могут быть мягко удалены, что позволяет их восстановление в будущем. Мягкое удаление изменяет статус бронирования на `DELETED`.
- **Просмотр бронирований** – предоставляет различные представления для просмотра всех бронирований пользователя, бронирований по конкретному листингу и всех бронирований, связанных с листингами, принадлежащими пользователю.
- **Права доступа** – встроены проверки прав доступа, позволяющие владельцам бронирований, владельцам листингов и администраторам управлять бронированиями.
- **Админ-панель** – включает в себя кастомные действия для изменения статуса бронирований, такие как активация, подтверждение, завершение, отмена и мягкое удаление.

### Структура приложения

- **models/** – содержит модель данных `Booking`, которая включает поля, связанные с пользователем, листингом, датами бронирования, статусом и ценой.
- **serializers/** – сериализаторы для различных операций с бронированиями, включая создание, обновление, просмотр и изменение статуса.
- **views/** – API-вьюшки для управления бронированиями, изменениями их статусов, а также для предоставления доступа к бронированиям конкретных пользователей или листингов.
- **permissions/** – кастомные разрешения для управления бронированиями, такие как `IsBookingOwner`, `IsListingOwner` и `IsAdminOrBookingOwnerOrListingOwner`.
- **admin/** – кастомизация административного интерфейса для бронирований, включающая действия для массового изменения статусов бронирований.
- **mixins/** – утилиты и миксины для работы со статусами и отображения состояния бронирования в админке.
- **tests/** – тесты для проверки функциональности приложения `bookings`, включая тестирование вьюшек, сериализаторов, и проверки прав доступа.

### Особенности работы с приложением `bookings`

- **Создание и обновление**: Пользователи могут создавать бронирования на основе указанных дат, а также редактировать их. Проверка доступности листинга для указанных дат осуществляется на уровне модели.
- **Изменение статуса**: Пользователи могут изменять статус бронирования (например, запрос, подтверждение, завершение, отмена) через специальные API-вьюхи. Статусные действия ограничены бизнес-логикой (например, завершение бронирования возможно только из статуса `CONFIRMED`).
- **Мягкое удаление**: Метод `soft_delete` изменяет статус бронирования на `DELETED`, не удаляя его из базы данных.
- **Права доступа**: Реализованы специальные разрешения (`IsBookingOwner`, `IsListingOwner`, `IsAdminOrBookingOwnerOrListingOwner`), чтобы только владельцы бронирований, владельцы листингов или администраторы могли просматривать и изменять бронирования.
- **Просмотр бронирований**: Пользователи могут просматривать только свои бронирования или бронирования своих листингов. Администраторы имеют доступ ко всем бронированиям, включая удаленные.
- **Админ-панель**: В админ-панели доступны действия для массового изменения статусов бронирований. Отображение статусов и метаданных реализовано через миксины (`StatusMixin`, `SoftDeleteMixin`).

### Тестирование

- **Unit-тесты**: покрывают основные операции с бронированиями, включая:
  - **Models**: тестирование поведения и валидации модели `Booking`.
  - **Serializers**: проверка сериализаторов для создания, обновления, изменения статуса и мягкого удаления бронирований.
  - **Views**: тестирование вьюшек для просмотра, создания, обновления и изменения статусов бронирований, с учетом прав доступа.
  - **Admin**: тестирование кастомных действий в админ-панели (подтверждение, завершение, мягкое удаление).

- **Разделение тестов**: тесты организованы по функциональным классам (создание, обновление, изменение статуса) и сгруппированы в отдельных файлах для каждой категории (models, serializers, views).

- **Запуск тестов**: все тесты приложения `bookings` можно запустить с помощью команды:

```bash
python manage.py test apps.bookings.tests
```

### Используемые технологии

- **Django** – фреймворк для веб-приложений.
- **Django REST Framework** – для реализации API.
- **Simple JWT** – для аутентификации с использованием токенов.

---

## Установка и запуск проекта

Проект **ToBookToStay** можно запустить двумя способами: с помощью Docker Compose или вручную, без Docker. Ниже приведены оба варианта.

### Вариант 1: Запуск через Docker Compose

Этот вариант предпочтителен для быстрого развертывания проекта с минимальной настройкой окружения.

#### 1. Клонирование репозитория

Клонируйте проект на вашу локальную машину:

```bash
git clone https://github.com/ваш-репозиторий/ToBookToStay.git
cd ToBookToStay
```

#### 2. Настройка переменных окружения

В корне проекта есть файл `.env.example`. Создайте файл `.env` на основе этого примера и заполните его нужными значениями:

```bash
cp .env.example .env
```

Пример содержимого `.env`:

```
SECRET_KEY=your_django_secret_key_here

DEBUG=True

DB_NAME=to_book_to_stay_db
DB_USER=db_user
DB_PASSWORD=db_password
DB_HOST=db
DB_PORT=3306

DB_ROOT_PASSWORD=your_secure_password_here

AWS_ACCESS_KEY_ID=your_aws_access_key
AWS_SECRET_ACCESS_KEY=your_aws_secret_key
AWS_STORAGE_BUCKET_NAME=your_bucket_name
AWS_REGION=your-aws-region

ALLOWED_HOSTS=127.0.0.1,localhost

MYSQL_PORT=3306
DJANGO_PORT=8000
```

#### 3. Запуск приложения через Docker

Запустите Docker и выполните команду для сборки и запуска проекта:

```bash
docker-compose up --build
```

Docker Compose автоматически соберет образ для вашего Django-приложения и запустит его вместе с контейнером базы данных MySQL. **Данные базы данных MySQL будут сохраняться в папке `./data`** в корневой директории проекта, что обеспечивает сохранение данных между перезапусками контейнеров.

#### 4. Скрипт для миграций

Скрипт `wait_for_db.sh` автоматически выполнит миграции после того, как база данных будет готова. Это происходит во время запуска контейнеров, поэтому **не нужно выполнять миграции вручную**.

#### 5. Создание суперпользователя

Для доступа к административной панели Django создайте суперпользователя:

```bash
docker-compose exec web python manage.py createsuperuser
```

Следуйте инструкциям, чтобы создать учетную запись суперпользователя.

#### 6. Доступ к приложению

После запуска контейнеров и выполнения миграций вы можете открыть браузер и перейти по адресу:

```
http://127.0.0.1:${DJANGO_PORT}
```

Порт по умолчанию указывается в файле `.env` через переменную `WEB_PORT`. Если вы изменили его в файле `.env`, используйте соответствующий порт:

```
http://127.0.0.1:<YOUR_CONFIGURED_PORT>
```

#### 7. Остановка проекта

Чтобы остановить проект, выполните:

```bash
docker-compose down
```

---

### Вариант 2: Запуск без Docker

Если вы хотите запустить проект локально без Docker, следуйте этим шагам:

#### 1. Клонирование репозитория

Клонируйте проект на вашу локальную машину:

```bash
git clone https://github.com/ваш-репозиторий/ToBookToStay.git
cd ToBookToStay
```

#### 2. Настройка виртуального окружения

Создайте виртуальное окружение и активируйте его:

```bash
python -m venv venv
source venv/bin/activate  # Для Linux/MacOS
# или
venv\Scripts\activate  # Для Windows
```

#### 3. Установка зависимостей

Установите зависимости из файла `requirements.txt`:

```bash
pip install -r requirements.txt
```

#### 4. Настройка переменных окружения

Скопируйте пример файла `.env` и настройте его:

```bash
cp .env.example .env
```

Отредактируйте файл `.env`, указав свои данные для базы данных и другие параметры.

#### 5. Настройка базы данных

Создайте базу данных в MySQL и настройте подключение в вашем файле `.env` (параметры `DB_NAME`, `DB_USER`, `DB_PASSWORD`, `DB_HOST`, `DB_PORT`).

Примените миграции для создания необходимых таблиц:

```bash
python manage.py migrate
```

#### 6. Запуск приложения

Запустите сервер разработки Django:

```bash
python manage.py runserver
```

Приложение будет доступно по адресу:

```
http://127.0.0.1:8000
```

#### 7. Создание суперпользователя

Создайте суперпользователя для доступа к админ-панели:

```bash
python manage.py createsuperuser
```

Следуйте инструкциям для создания суперпользователя.

#### 8. Остановка сервера

Для остановки сервера нажмите `Ctrl + C` в терминале, где запущен сервер разработки.

## Установка и запуск проекта на AWS

Проект **ToBookToStay** можно развернуть на AWS, используя Docker Compose. Это позволит вам быстро развернуть проект с минимальной настройкой окружения на EC2 экземпляре.

#### 1. Настройка EC2

Начните с развертывания EC2 экземпляра в AWS (например, Amazon Linux 2). На этом этапе вам нужно будет выполнить следующие шаги:

- **Настроить ключи доступа SSH** для подключения к вашему серверу.
- **Открыть порты** 22 (SSH), 80 (HTTP), 443 (HTTPS), и 8000 (для приложения Django) в Security Group для доступа извне.
- **(Опционально) Назначить IAM роль** вашему EC2 экземпляру для доступа к S3 и другим AWS сервисам без необходимости указания ключей доступа напрямую.

После настройки EC2, вы можете подключиться к вашему серверу по SSH и приступить к установке необходимых инструментов.

#### 2. Установка необходимых инструментов

Подключитесь к вашему EC2 экземпляру по SSH и выполните следующие команды для установки Git, Docker и Docker Compose:

```
# Обновление системы
sudo yum update -y

# Установка Git
sudo yum install git -y
git --version

# Установка Docker
sudo yum install docker -y
sudo systemctl start docker
sudo systemctl enable docker
docker --version

# Установка Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
docker-compose --version
```

#### 3. Клонирование репозитория

Клонируйте репозиторий проекта на ваш EC2 сервер:

```bash
git clone https://github.com/ваш-репозиторий/ToBookToStay.git
cd ToBookToStay
```

#### 4. Настройка переменных окружения

В корне проекта есть файл `.env.example`. Создайте файл `.env` на основе этого примера и заполните его значениями, которые соответствуют вашему окружению:

```bash
cp .env.example .env
```

Пример содержимого `.env` для AWS:

```bash
SECRET_KEY=your_django_secret_key_here

DEBUG=True

DB_NAME=to_book_to_stay_db
DB_USER=db_user
DB_PASSWORD=db_password
DB_HOST=db
DB_PORT=3306

DB_ROOT_PASSWORD=your_secure_password_here

AWS_ACCESS_KEY_ID=your_aws_access_key
AWS_SECRET_ACCESS_KEY=your_aws_secret_key
AWS_STORAGE_BUCKET_NAME=your_bucket_name
AWS_REGION=your-aws-region

ALLOWED_HOSTS=127.0.0.1,localhost,your-ec2-public-ip

MYSQL_PORT=3306
DJANGO_PORT=8000
```

1. **AWS_ACCESS_KEY_ID** и **AWS_SECRET_ACCESS_KEY** — это ваши ключи доступа AWS (если вы не настроили IAM роль).
2. **AWS_STORAGE_BUCKET_NAME** — имя вашего S3 бакета для хранения медиафайлов.
3. **AWS_REGION** — регион вашего S3 бакета (например, `eu-central-1` для Франкфурта).
4. **ALLOWED_HOSTS** — обязательно добавьте публичный IP-адрес вашего EC2 экземпляра, чтобы разрешить доступ к приложению через этот IP.

#### 5. Запуск приложения через Docker Compose

После настройки переменных окружения, вы можете запустить проект с помощью Docker Compose. Это автоматически запустит как Django-приложение, так и базу данных MySQL.

```bash
docker-compose up --build -d
```

Docker Compose соберет образ для вашего Django-приложения и запустит его вместе с контейнером базы данных MySQL. Приложение будет доступно по адресу:

```
http://your-ec2-public-ip:8000
```

#### 6. Создание суперпользователя

Чтобы создать суперпользователя для доступа к административной панели Django, выполните команду:

```bash
docker-compose exec web python manage.py createsuperuser
```

Следуйте инструкциям, чтобы создать учетную запись суперпользователя.

#### 7. Остановка контейнеров

Если вам нужно остановить проект, выполните следующую команду:

```bash
docker-compose down
```

Эта команда остановит все контейнеры и удалит созданные ресурсы.

---

## Используемые технологии

- **Django** (v5.1.1) – фреймворк для веб-приложений.
- **MySQL** – реляционная база данных.
- **Docker** – контейнеризация приложения для упрощения развёртывания.
- **Docker Compose** – инструмент для управления многосервисными контейнерами.

---

## Локализация docstring'ов

Проект поддерживает локализацию docstring'ов для функций и модулей. Используйте декоратор `localized_docstring`, чтобы настроить docstring'и на разных языках.

### Пример использования:

```python
from common.utils.localized_docs import localized_docstring

@localized_docstring({
    'en': "This function handles listing operations.",
    'ru': "Эта функция обрабатывает операции с объявлениями."
})
def some_listing_function():
    pass
```
```bash
python
>>>from some.path.to.module import some_listing_function
>>>print(some_listing_function.__doc__)
>>>exit()
```
Смена языка в файле `doc_config.py` в переменной `doc_language`.

### Тестирование

Локализация docstring'ов покрыта unit-тестом, который находятся в директории `common/tests/`. Чтобы запустить тест, выполните команду:

```bash
python -m unittest common/tests/test_localized_docs.py
```

---

## Авторы

Проект разработан **Sergei Oskolkov**

---

## Лицензия

Этот проект лицензирован под [Creative Commons Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)](https://creativecommons.org/licenses/by-nc/4.0/).

Вы можете:
- Делать копии, распространять и передавать этот проект.
- Изменять и адаптировать проект для своих нужд.

Условие:
- Вы должны указать авторство (Sergei Oskolkov, проект ToBookToStay) и предоставить ссылку на лицензию.
- Никакого коммерческого использования без разрешения.

Подробнее: [https://creativecommons.org/licenses/by-nc/4.0/](https://creativecommons.org/licenses/by-nc/4.0/)

---